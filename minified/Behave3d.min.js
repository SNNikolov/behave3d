"use strict";function Behave3d(e,t){return void 0===t&&(t=!0),Behave3d.selector(e,t)}if(Behave3d.controllers={},Behave3d.params={},Behave3d.ui={},Behave3d.consts={VERSION:.81,FRAME_RATE:60,PHYSICS_FRAME_RATE:600,GRAVITY_CONSTANT:400,BEHAVE3D_ATTRIB:"behave3d",BEHAVE3D_PROPERTY:"behave3d",FRAME_TIMER_TYPE:"st",SHORTTERM_FRAME_DURATION_M:.2,LONGTTERM_FRAME_DURATION_M:.01,MAX_SUBFRAMES_PER_FRAME:1,SUBFRAMES_PRECISION:.2,ROTATE_UNIT:"deg",ROTATE_ONE_TURN:360,RADIANS_TO_UNITS:360/(2*Math.PI),PRECISION_TRANSLATE:1,PRECISION_ROTATE:3,PRECISION_ROTATE_ANGLE:1,PRECISION_SCALE:3,PRECISION_OPACITY:2,CSS_TRANSFORMS_PREFIX:"",DEBUG:!1,DEBUG_STATS_CONTAINER:""},window.behave3dConstants)for(window.behave3dConstants.i in window.behave3dConstants)Behave3d.consts[window.behave3dConstants.i]=window.behave3dConstants[window.behave3dConstants.i];Behave3d.transforms={translate:{dx:0,dy:0,dz:0},scale:{sx:1,sy:1,sz:1},rotate:{rx:0,ry:0,rz:0,ra:0},origin:{ox:.5,oy:.5,oz:0},opacity:{opacity:1},flatten:{flatten:!0}},Behave3d.vars={engineIsPaused:!1,frameDuration:1e3/Behave3d.consts.FRAME_RATE,frameTimerType:"",frameTimerID:null,sceneParams:{},elementsPool:[],elementsToRemove:[],sceneContainer:null,sceneController:null,uniqueIDCounter:0,delayedInits:!1,unitRem:1,cssPropTransform:"transform",cssPropTransformStyle:"transformStyle",cssPropTransformOrigin:"transformOrigin",cssPropPerspective:"perspective",cssPropPerspectiveOrigin:"perspectiveOrigin",lastFrameTimestamp:0,lastFrameSubframes:1,longTermFrameDuration:0,shortTermFrameDuration:0,mousePosX:0,mousePosY:0,debugInfo:{}},Behave3d.startEngine=function(){Behave3d.vars.elementsPool=[],Behave3d.vars.frameTimerType=Behave3d.consts.FRAME_TIMER_TYPE,"raf"!=Behave3d.vars.frameTimerType||window.requestAnimationFrame||(Behave3d.debugOut("startEngine() falls back to setTimeout() because requestAnimationFrame() is not supported"),Behave3d.vars.frameTimerType="st"),Behave3d.vars.frameTimerID="raf"==Behave3d.vars.frameTimerType?window.requestAnimationFrame(Behave3d.runThisFrame):window.setTimeout(Behave3d.runThisFrame,Behave3d.vars.frameDuration),Behave3d.vars.engineIsPaused=!1,Behave3d.calculateUnits(),Behave3d.setCSSPrefixes(Behave3d.consts.CSS_TRANSFORMS_PREFIX),document.addEventListener("mousemove",Behave3d.mouseEventListener,!0),document.addEventListener("touchmove",Behave3d.mouseEventListener,!0)},Behave3d.stopEngine=function(){"raf"==Behave3d["var"].frameTimerType?window.cancelAnimationFrame&&window.cancelAnimationFrame(Behave3d.vars.frameTimerID):window.clearTimeout(Behave3d.vars.frameTimerID)},Behave3d.isEnginePaused=function(){return Behave3d.vars.engineIsPaused},Behave3d.pauseEngine=function(e){void 0===e&&(e=!Behave3d.vars.engineIsPaused),Behave3d.vars.engineIsPaused=e,Behave3d.debugOut("behave3d engine is "+(e?"":"un")+"paused")},Behave3d.calculateUnits=function(){if(document.body){var e=document.createElement("div");e.style.boxSizing="border-box",e.style.width="1000rem",document.body.appendChild(e),Behave3d.vars.unitRem=e.offsetWidth/1e3,document.body.removeChild(e)}},Behave3d.setCSSPrefixes=function(e){function t(e,t){return""==t?e:t+e.substr(0,1).toUpperCase()+e.substr(1)}Behave3d.vars.cssPropTransform=t("transform",e),Behave3d.vars.cssPropTransformStyle=t("transformStyle",e),Behave3d.vars.cssPropTransformOrigin=t("transformOrigin",e),Behave3d.vars.cssPropPerspective=t("perspective",e),Behave3d.vars.cssPropPerspectiveOrigin=t("perspectiveOrigin",e)},Behave3d.setScene=function(e,t){Array.isArray(e)&&(e=Behave3d.params.getParamsAsObject(e)),Behave3d.vars.sceneParams=Behave3d.params.extendObject(Behave3d.vars.sceneParams,e),Behave3d.vars.sceneController=t,Behave3d.vars.sceneContainer=t.owner.element,Behave3d.vars.sceneParams.perspective=Behave3d.params.getLength(Behave3d.vars.sceneParams.perspective,"Z",Behave3d.vars.sceneContainer,!1),Behave3d.vars.sceneContainer.style[Behave3d.vars.cssPropPerspective]=Behave3d.vars.sceneParams.perspective+"px",Behave3d.vars.sceneContainer.style[Behave3d.vars.cssPropPerspectiveOrigin]=Behave3d.vars.sceneParams.perspective_origin_x+"% "+Behave3d.vars.sceneParams.perspective_origin_y+"%"},Behave3d.updateViewport=function(){Behave3d.vars.sceneController&&Behave3d.vars.sceneController.updateViewport()},Behave3d.mouseEventListener=function(e){"mousemove"==e.type?(Behave3d.vars.mousePosX=e.pageX,Behave3d.vars.mousePosY=e.pageY):"touchmove"==e.type&&(Behave3d.vars.mousePosX=e.changedTouches[0].pageX,Behave3d.vars.mousePosY=e.changedTouches[0].pageY)},Behave3d.registerController=function(e,t){if(Behave3d.controllers[e]&&Behave3d.debugOut("Controller with title '"+e+"' is registered again! Mind your references"),t.prototype.requires&&t.prototype.requires.controllers){for(var s=[],r=0;r<t.prototype.requires.controllers.length;r++){var a=t.prototype.requires.controllers[r];Behave3d[a]||s.push(a)}s.length>0&&Behave3d.debugExit("behave3d controller '"+e+"' requires the following controllers: "+s.join(", "))}Behave3d.controllers[e]=t,t.prototype.title=e},Behave3d.updatePool=function(e,t){void 0===t&&(t=Behave3d.consts.BEHAVE3D_ATTRIB),Behave3d.debugOut("Engine - updating pool...");for(var s=Behave3d.vars.elementsPool,r=document.querySelectorAll("["+t+"]"),a=s.length-1;a>=0;a--)s[a].style&&!document.contains(s[a])&&(Behave3d.debugOut(s[a][Behave3d.consts.BEHAVE3D_PROPERTY].debugName()+" is removed from pool"),s.splice(a,1));Behave3d.vars.delayedInits=[];for(var a=0;a<r.length;a++)r[a][Behave3d.consts.BEHAVE3D_PROPERTY]||new Behave3d.Element(r[a],!0,t);Behave3d.doDelayedInits(),Behave3d.vars.sceneContainer||Behave3d(document.body).add("scene")},Behave3d.selector=function(e,t){void 0===t&&(t=!1);var s,r="";window.jQuery&&e instanceof jQuery?e=e[0]:"string"==typeof e&&2==(s=e.split(" ")).length?(e=s[0],r=s[1]):Array.isArray(e)&&(r=e[1],e=e[0]);var a=Behave3d.getDOMElement(e);return a?""!=r?(a[Behave3d.consts.BEHAVE3D_PROPERTY]||Behave3d.debugExit("Cannot find controller '"+r+"' in element "+e+" - supplied element doesn't have Behave3d.Element"),a[Behave3d.consts.BEHAVE3D_PROPERTY].getController(r)||Behave3d.debugExit("Cannot find controller '"+r+"' in element "+e)):a[Behave3d.consts.BEHAVE3D_PROPERTY]?a[Behave3d.consts.BEHAVE3D_PROPERTY]:(t||Behave3d.debugExit("Element "+e+" doesn't have Behave3d.Element"),new Behave3d.Element(a)):!1},Behave3d.doDelayedInits=function(){Behave3d.vars.delayedInits&&(["events","messages"].forEach(function(e){for(var t=0;t<Behave3d.vars.delayedInits.length;t++){var s=Behave3d.vars.delayedInits[t];s.controller.construct&&s.controller.construct(s.params,e),s.controller.set(s.params,e)}}),Behave3d.vars.delayedInits=!1)},Behave3d.runThisFrame=function(){if(!Behave3d.vars.engineIsPaused){var e=Date.now(),t=0,s=1;Behave3d.vars.lastFrameTimestamp&&(t=(e-Behave3d.vars.lastFrameTimestamp)/Behave3d.vars.lastFrameSubframes,Behave3d.vars.shortTermFrameDuration?t/Behave3d.vars.shortTermFrameDuration<=4&&(Behave3d.vars.longTermFrameDuration=t*Behave3d.consts.LONGTTERM_FRAME_DURATION_M+Behave3d.vars.longTermFrameDuration*(1-Behave3d.consts.LONGTTERM_FRAME_DURATION_M),Behave3d.vars.shortTermFrameDuration=t*Behave3d.consts.SHORTTERM_FRAME_DURATION_M+Behave3d.vars.shortTermFrameDuration*(1-Behave3d.consts.SHORTTERM_FRAME_DURATION_M)):Behave3d.vars.longTermFrameDuration=Behave3d.vars.shortTermFrameDuration=t,s=Math.round(t/Behave3d.vars.longTermFrameDuration-Behave3d.consts.SUBFRAMES_PRECISION),s=Math.max(1,Math.min(Behave3d.consts.MAX_SUBFRAMES_PER_FRAME,s)),s>1&&Behave3d.debugOut("Engine runs "+s+" frames at once - last frame's duration = "+t.toFixed(1)+"ms, average = "+Behave3d.vars.longTermFrameDuration.toFixed(1)+"ms")),Behave3d.vars.lastFrameTimestamp=e,Behave3d.vars.lastFrameSubframes=s;do{Behave3d.consts.DEBUG&&(Behave3d.vars.debugInfo.count_behave3d_elements=0,Behave3d.vars.debugInfo.count_transformed_elements=0,Behave3d.vars.debugInfo.count_translations=0,Behave3d.vars.debugInfo.count_rotations=0,Behave3d.vars.debugInfo.count_scalings=0,Behave3d.vars.debugInfo.count_origins=0,Behave3d.vars.debugInfo.count_opacities=0),Behave3d.vars.elementsToRemove=[];for(var r=0;r<Behave3d.vars.elementsPool.length;r++)Behave3d.vars.elementsPool[r][Behave3d.consts.BEHAVE3D_PROPERTY].cleanTransforms();for(var r=0;r<Behave3d.vars.elementsPool.length;r++)Behave3d.vars.elementsPool[r][Behave3d.consts.BEHAVE3D_PROPERTY].updateControllers();for(var r=0;r<Behave3d.vars.elementsPool.length;r++)Behave3d.vars.elementsPool[r][Behave3d.consts.BEHAVE3D_PROPERTY].calcPhysics(!0),Behave3d.vars.elementsPool[r][Behave3d.consts.BEHAVE3D_PROPERTY].applyTransforms();for(var r=0;r<Behave3d.vars.elementsToRemove.length;r++)Behave3d.vars.elementsPool.splice(Behave3d.vars.elementsPool.indexOf(Behave3d.vars.elementsToRemove[r]),1)}while(--s>0);Behave3d.vars.frameTimerID="raf"==Behave3d.vars.frameTimerType?window.requestAnimationFrame(Behave3d.runThisFrame):window.setTimeout(Behave3d.runThisFrame,Behave3d.vars.frameDuration),Behave3d.consts.DEBUG&&Behave3d.consts.DEBUG_STATS_CONTAINER&&(Behave3d.vars.debug_box_ref||(Behave3d.vars.debug_box_ref=document.getElementById(Behave3d.consts.DEBUG_STATS_CONTAINER),Behave3d.vars.debug_box_ref&&(Behave3d.vars.debug_box_ref.style.visibility="visible")),Behave3d.vars.debug_box_ref?Behave3d.vars.debug_box_ref.innerHTML="elements: "+Behave3d.vars.debugInfo.count_behave3d_elements+"<br/>transformed: "+Behave3d.vars.debugInfo.count_transformed_elements+"<br/>translations: "+Behave3d.vars.debugInfo.count_translations+"<br/>rotations: "+Behave3d.vars.debugInfo.count_rotations+"<br/>scalings: "+Behave3d.vars.debugInfo.count_scalings+"<br/>origins: "+Behave3d.vars.debugInfo.count_origins+"<br/>opacities: "+Behave3d.vars.debugInfo.count_opacities+"<br/>frame duration: "+t.toFixed(1)+"<br/>framerate long-term:  "+Behave3d.vars.longTermFrameDuration.toFixed(1)+"<br/>framerate short-term: "+Behave3d.vars.shortTermFrameDuration.toFixed(1):Behave3d.debugExit("!"))}},Behave3d.params.parseItemsString=function(e,t){void 0===t&&(t=!1);var s=t?{}:[];if(""==e.trim())return s;e=e.split("|");for(var r=0;r<e.length;r++){var a=e[r].trim(),n=a,o=t?{}:[];if(")"==a.trim().substr(-1)){var i=a.indexOf("(");-1!=i&&(n=a.substr(0,i).trim(),o=Behave3d.params.parseParamsString(a.substring(i+1,a.length-1),t))}t?s[n]=o:s.push({title:n,params:o})}return s},Behave3d.params.parseParamsString=function(e,t){for(var s=e.split(","),r=t?{}:[],a=0;a<s.length;a++){var n=s[a].trim(),o=n,i=!0;if(""!=o){var h=s[a].indexOf(":");-1!=h&&(o=s[a].substr(0,h).trim(),i=s[a].substr(h+1).trim(),Behave3d.params.isNumber(i)?i=Number(i):"true"==i.toLowerCase()?i=!0:"false"==i.toLowerCase()&&(i=!1)),t?r[o]=i:r.push([o,i])}}return r},Behave3d.params.getParamsAsArray=function(e){var t=[];for(var s in e)t.push([s,e[s]]);return t},Behave3d.params.getParamsAsObject=function(e){for(var t={},s=0;s<e.length;s++)t[e[s][0]]=e[s][1];return t},Behave3d.params.getItemsAsArray=function(e){var t=[];for(var s in e)t.push({title:s,params:Behave3d.params.getParamsAsArray(e[s])});return t},Behave3d.params.getParam=function(e,t,s){void 0===s&&(s=!1);for(var r=0;r<e.length;r++)if(e[r][0]==t){var a=e[r][1];return s&&e.splice(r,1),a}},Behave3d.params.extendObject=function(e,t,s){void 0===s&&(s=!1);var r={};for(var a in e)r[a]=e[a];for(var a in t)(!s||r.hasOwnProperty(a))&&(r[a]=t[a]);return r},Behave3d.params.isNumber=function(e,t){return Number(t?parseInt(e):parseFloat(e))==e},Behave3d.params.getLength=function(e,t,s,r){if(Behave3d.params.isNumber(e))return Number(e);var a="Invalid length parameter '"+e+"' - ";if("string"!=typeof e&&Behave3d.debugExit(a+"not a string, nor number"),r&&Array.isArray(r)&&r.indexOf(e)>=0)return e;var n=100,o=0,i=2,h=e.substr(-1);"X"==h||"Y"==h||"Z"==h?(t=h,e=e.substr(0,e.length-1),h=e.substr(-1)):t||Behave3d.debugExit(a+"no axis");var d=e.substr(-2),v=e.substr(-3);if("rem"==v)i=3,n=100*Behave3d.vars.unitRem;else if("%"==h)i=1,n="X"==t?s.parentNode.clientWidth:"Y"==t?s.parentNode.clientHeight:Behave3d.vars.sceneParams.perspective;else if("%p"==d)n="Y"==t?s.parentNode.clientHeight:s.parentNode.clientWidth;else if("%o"==d)n="Y"==t?s.clientHeight:s.clientWidth;else if("%d"==d)n="Y"==t?document.documentElement.clientHeight:document.documentElement.clientWidth;else if("%v"==d)n="Y"==t?window.top.innerHeight:window.top.innerWidth;else if("o"==h)i=1;else if("p"==h)i=1,o=-("Y"==t?s.offsetTop:s.offsetLeft);else if("d"==h)i=1,s&&(o=-Behave3d.getElementPos(s,!1,!0)[t.toLowerCase()]);else if("v"==h)i=1,o=s?-Behave3d.getElementPos(s,!1,!0,!0)[t.toLowerCase()]:"Y"==t?window.pageYOffset:window.pageXOffset;else{if(r&&!Array.isArray(r))return e;Behave3d.debugExit(a+"unknown format")}var l=o+Number(e.substr(0,e.length-i));return Behave3d.params.isNumber(l)||Behave3d.debugExit(a+"not a number"),l*n/100},Behave3d.getDOMElement=function(e){var t="string"==typeof e?document.getElementById(e):e;return t?t.nodeName||t instanceof Window||t instanceof Document||Behave3d.debugExit("HTML element expected, another object type received"):Behave3d.debugExit("Cannot find HTML element '"+e+"'"),t},Behave3d.getElementPos=function(e,t,s,r){if(void 0===t&&(t=!1),"@mouse"===e)return{x:Behave3d.vars.mousePosX-(r?window.pageXOffset:0),y:Behave3d.vars.mousePosY-(r?window.pageYOffset:0),z:0};if(!(e=Behave3d.getDOMElement(e)))return!1;var a={x:0,y:0,z:0};if(s){var n=e.offsetWidth,o=e.offsetHeight,i=e;do for(a.x+=e.offsetLeft-e.scrollLeft,a.y+=e.offsetTop-e.scrollTop,e=e.offsetParent,i=i.parentNode;i!=e;)a.x-=i.scrollLeft,a.y-=i.scrollTop,i=i.parentNode;while(e.offsetParent);r&&(a.x-=window.pageXOffset,a.y-=window.pageYOffset),t&&(a.x+=n/2,a.y+=o/2)}else{var h=e.getBoundingClientRect();a.x=h.left,a.y=h.top,r||(a.x+=window.pageXOffset,a.y+=window.pageYOffset),t&&(a.x+=h.width/2,a.y+=h.height/2)}return a},Behave3d.getAngle=function(e,t){var s=t.x-e.x,r=t.y-e.y,a=Math.atan2(r,s)*Behave3d.consts.RADIANS_TO_UNITS;return 0>a&&(a+=Behave3d.consts.ROTATE_ONE_TURN),a},Behave3d.getFunctionByName=function(e){if("function"==typeof e)return e;if(!e)return null;for(var t=e.split("."),s=t.pop(),r=window,a=0;a<t.length;a++){if(!r[t[a]])return null;r=r[t[a]]}return"function"==typeof r[s]?r[s]:null},Behave3d.getAccForDisplacement=function(e,t){void 0===t&&(t=1/Behave3d.consts.FRAME_RATE);var s=t*t/2;return{x:e.x/s,y:e.y/s,z:e.z/s}},Behave3d.getAccForSpeed=function(e,t){return void 0===t&&(t=1/Behave3d.consts.FRAME_RATE),{x:e.x/t,y:e.y/t,z:e.z/t}},Behave3d.isAnglePassed=function(e,t,s,r){var a=(t-e)%r,n=(s-e)%r;return 0>(t-s)*a?!1:a>=0&&(0>n||n>a)?!0:0>=a&&(n>0||a>n)?!0:!1},Behave3d.ease=function(e,t,s,r,a,n){function o(e,t){switch(t){case"ease":return.5-.5*Math.cos(Math.PI*e);case"ease_in":return 1-Math.cos(.5*Math.PI*e);case"ease_out":return-Math.cos(.5*Math.PI*(1+e));default:Behave3d.debugExit("Unknown ease type '"+t+"' supplied to Behave3d.ease()")}}if(void 0===n&&(n="total"),0==r)return e;if(0==e)return e;if("linear"==t||0==s)return"total"==n?e*(a+1)/r:e;var i=(a+1)/r,h=o(i,t);if("current"==n)return e*(1+(h-1)*s);var d,v=r+t;if(Behave3d.ease.steps_cache||(Behave3d.ease.steps_cache={}),!(d=Behave3d.ease.steps_cache[v])){d={steps:[],sums:[]};for(var l=0,c=o(0,t),m=0;r>m;m++){var u=o((m+1)/r,t)-c;c+=u,l+=u,d.steps.push(u),d.sums.push(l)}d.steps.push(l),Behave3d.ease.steps_cache[v]=d}if("step"==n){var f=e*r,u=f*d.steps[a]/d.steps[r];return e*(1+(u/e-1)*s)}var p=e*d.sums[a]/d.steps[r],B=e*i;return B*(1+(p/B-1)*s)},Behave3d.ease.easeTypes=["linear","ease","ease_in","ease_out"],Behave3d.ease.mirrorMap={linear:"linear",ease:"ease",ease_in:"ease_out",ease_out:"ease_in"},Behave3d.debugOut=function(e){Behave3d.consts.DEBUG&&console.log("behave3d:  "+e)},Behave3d.debugExit=function(e){throw"behave3d:  "+e},Behave3d.Element=function(e,t,s){return void 0===t&&(t=!0),void 0===s&&(s=Behave3d.consts.BEHAVE3D_ATTRIB),(e=Behave3d.getDOMElement(e))?(e[Behave3d.consts.BEHAVE3D_PROPERTY]=this,this.element=e,this.is_pooled=!1,this.controllers=[],this.transforms=[],this.last_transform_str="",this.last_origin_str="",this.last_style_str="",this.last_opacity_str="",this.pos={x:0,y:0,z:0},this.velocity={x:0,y:0,z:0},this.acc={x:0,y:0,z:0},this.physics_enabled=!1,t&&this.addToPool(),this.actions_controller=this.addController(Behave3d.controllerActions,{id:"a"}),e.getAttribute&&s&&this.add(e.getAttribute(s)),void this.configureDOMParents()):!1},Behave3d.Element.required_core_controllers=["actions","scene"],Behave3d.Element.prototype={},Behave3d.Element.prototype.configureDOMParents=function(){for(var e=this.element;(e=e.parentNode)&&e!==Behave3d.vars.sceneContainer&&e!==document.body&&e.style;)e.style[Behave3d.vars.cssPropTransformStyle]||(e.style[Behave3d.vars.cssPropTransformStyle]="preserve-3d");return this},Behave3d.Element.prototype.addToPool=function(){return Behave3d.debugOut("Element - add to pool: "+this.debugName()),Behave3d.vars.elementsPool.indexOf(this.element)>=0?(Behave3d.debugOut("Skipped adding element to pool because its already there: "+this.debugName()),this):(Behave3d.vars.elementsPool.push(this.element),this.is_pooled=!0,this)},Behave3d.Element.prototype.removeFromPool=function(){Behave3d.debugOut("Element - remove from pool: "+this.debugName());var e=Behave3d.vars.elementsPool.indexOf(this.element);return(0>e||!this.is_pooled)&&Behave3d.debugExit(this.debugName()+".removeFromPool() fails because element is not in the pool"),this.removeAllControllers(),Behave3d.vars.elementsToRemove.push(this.element),this.is_pooled=!1,this},Behave3d.Element.prototype.add=function(e,t){if(!e)return t?[]:this;var s="string"==typeof e?Behave3d.params.parseItemsString(e):e;s||Behave3d.debugExit("Error in controllers definition for "+this.debugName()+": '"+e+"'");var r=Behave3d.vars.delayedInits===!1;Behave3d.vars.delayedInits=Behave3d.vars.delayedInits||[];for(var a=[],n=0;n<s.length;n++){var o=this.addController(s[n].title,s[n].params);t&&a.push(o)}return r&&Behave3d.doDelayedInits(),t?a:this},Behave3d.Element.prototype.addController=function(e,t){void 0===t&&(t=[]),Array.isArray(t)||(t=Behave3d.params.getParamsAsArray(t));var s;if(("actions"===e||e===Behave3d.controllerActions)&&this.controllers.length>0)s=this.actions_controller;else{for(var r=!1,a=!1,n=0;n<t.length;n++)"targets"==t[n][0]?r=!0:"owner"==t[n][0]&&(a=!0);if(a||t.unshift(["owner",this]),r||t.unshift(["targets",[this.element]]),"string"==typeof e&&!Behave3d.controllers[e]){var o="behave3d is attempting to instantiate unregistered controller '"+e+"'";Behave3d.Element.required_core_controllers.indexOf(e)>=0&&(o+="\nPlease make sure the definition files for the following controllers are included in your project as they are always used: "+Behave3d.Element.required_core_controllers.join(", ")),Behave3d.debugExit(o)}var i="string"==typeof e?Behave3d.controllers[e]:e;s=new i(t),this.controllers.push(s)}return Behave3d.vars.delayedInits===!1?(s.construct&&s.construct(t,"events"),s.set(t,"events"),s.construct&&s.construct(t,"messages"),s.set(t,"messages")):Behave3d.vars.delayedInits.push({controller:s,params:t}),s},Behave3d.Element.prototype.removeAllControllers=function(){for(var e=this.controllers.length-1;e>=0;e--)this.removeController(e)},Behave3d.Element.prototype.removeController=function(e){var t;return t="object"==typeof e?this.getControllerIndex(e):Behave3d.params.isNumber(e)?e:this.getController(e,!0),this.controllers[t]||Behave3d.debugExit(this.debugName()+".removeController("+("object"==typeof e?e.debugName():e)+") - cannot find controller in controllers list! controller_index="+t),e=this.controllers[t],Behave3d.debugOut("Controller - remove: "+e.debugName()),e.fireEvent("remove"),this.controllers.splice(t,1),e.destruct&&e.destruct.call(e),e.disabled=!0,this},Behave3d.Element.prototype.getControllerIndex=function(e){for(var t=0;t<this.controllers.length;t++)if(this.controllers[t]===e)return t;return-1},Behave3d.Element.prototype.getDOMElement=function(e,t){var s;if("string"==typeof e&&(e=e.toLowerCase()),"@this"===e)s=this.element;else if("@parent"===e)s=this.element.parentNode;else if("@ancestor"===e)for(s=this.element.parentNode;s&&!Behave3d(s,!1);)s=s.parentNode;else s=Behave3d.getDOMElement(e);return t?s[Behave3d.consts.BEHAVE3D_PROPERTY]:s},Behave3d.Element.prototype.forEachController=function(e,t,s,r){if(e)for(var a=0;a<this.controllers.length;a++)r.call(this.controllers[a]);if(t)for(var n;(n=this.element.parentNode)&&n!=document;)n[Behave3d.consts.BEHAVE3D_PROPERTY]&&n[Behave3d.consts.BEHAVE3D_PROPERTY].forEachController(!0,!1,!1,r);if(s)for(var o=this.childNodes?this.childNodes:this.element.childNodes,i=0;i<o.length;i++){var h=o[i];h[Behave3d.consts.BEHAVE3D_PROPERTY]?h[Behave3d.consts.BEHAVE3D_PROPERTY].forEachController(!0,!1,!0,r):Behave3d.Element.prototype.forEachController.call(h,!1,!1,!0,r)}},Behave3d.Element.prototype.getController=function(e,t){void 0===t&&(t=!1);for(var s=0;s<this.controllers.length;s++)if(this.controllers[s].id==e)return t?s:this.controllers[s];return!1},Behave3d.Element.prototype.updateControllers=function(){Behave3d.consts.DEBUG&&Behave3d.vars.debugInfo.count_behave3d_elements++;for(var e=0;e<this.controllers.length;e++)this.controllers[e].to_be_updated=!0;for(var t=!0;t;){t=!1;for(var e=0;e<this.controllers.length;e++){var s=this.controllers[e],r=this.controllers.length;if(s.to_be_updated&&(s.event_handlers.frame&&s.fireEvent("frame",{},"controller"),!s.disabled&&s.update&&s.update.call(s),s.to_be_updated=!1,t=r!=this.controllers.length))break}}},Behave3d.Element.prototype.message=function(e,t,s){void 0===s&&(s="local");var r="global"==s,a="parents"==s||"p_and_c"==s,n="children"==s||"p_and_c"==s,o="local"==s,i=0;if(o&&(this.actions_controller.message(e,t),i++),r)for(var h=0;h<Behave3d.vars.elementsPool.length;h++)i+=Behave3d.vars.elementsPool[h][Behave3d.consts.BEHAVE3D_PROPERTY].message(e,t,"local");if(a)for(var d;(d=this.element.parentNode)&&d!=document;)d[Behave3d.consts.BEHAVE3D_PROPERTY]&&(i+=d[Behave3d.consts.BEHAVE3D_PROPERTY].message(e,t,"local"));if(n)for(var v=this.childNodes?this.childNodes:this.element.childNodes,l=0;l<v.length;l++){var c=v[l];c[Behave3d.consts.BEHAVE3D_PROPERTY]?(i+=c[Behave3d.consts.BEHAVE3D_PROPERTY].message(e,t,"local"),i+=c[Behave3d.consts.BEHAVE3D_PROPERTY].message(e,t,"children")):i+=Behave3d.Element.prototype.message.call(c,e,t,"children")}return i},Behave3d.Element.prototype.show=function(e){return this.message(e?"show_immediately":"show"),this},Behave3d.Element.prototype.hide=function(e){return this.message(e?"hide_immediately":"hide"),this},Behave3d.Element.prototype.addTransform=function(e){return this.transforms.push(e),this},Behave3d.Element.prototype.cleanTransforms=function(){return this.transforms.length=0,this.physics_enabled&&(this.acc.x=this.acc.y=this.acc.z=0),this},Behave3d.Element.prototype.applyTransforms=function(){if(this.element.style){for(var e=[],t=!1,s=!1,r="",a=0,n=0,o=0,i=0;i<this.transforms.length;i++){var h=this.transforms[i];h.type===Behave3d.transforms.translate?(h.dx=h.dx.toFixed(Behave3d.consts.PRECISION_TRANSLATE),h.dy=h.dy.toFixed(Behave3d.consts.PRECISION_TRANSLATE),h.dz=h.dz.toFixed(Behave3d.consts.PRECISION_TRANSLATE),e.push("translate3d("+h.dx+"px, "+h.dy+"px, "+h.dz+"px)"),a++):h.type===Behave3d.transforms.rotate?(h.rx=h.rx.toFixed(Behave3d.consts.PRECISION_ROTATE),h.ry=h.ry.toFixed(Behave3d.consts.PRECISION_ROTATE),h.rz=h.rz.toFixed(Behave3d.consts.PRECISION_ROTATE),h.ra=h.ra.toFixed(Behave3d.consts.PRECISION_ROTATE_ANGLE),e.push("rotate3d("+h.rx+", "+h.ry+", "+h.rz+", "+h.ra+Behave3d.consts.ROTATE_UNIT+")"),n++):h.type===Behave3d.transforms.scale?(h.sx=h.sx.toFixed(Behave3d.consts.PRECISION_SCALE),h.sy=h.sy.toFixed(Behave3d.consts.PRECISION_SCALE),h.sz=h.sz.toFixed(Behave3d.consts.PRECISION_SCALE),e.push("scale3d("+h.sx+", "+h.sy+", "+h.sz+")"),o++):h.type===Behave3d.transforms.origin?(h.ox=h.ox.toFixed(Behave3d.consts.PRECISION_SCALE),h.oy=h.oy.toFixed(Behave3d.consts.PRECISION_SCALE),h.oz=h.oz.toFixed(Behave3d.consts.PRECISION_TRANSLATE),t=h):h.type===Behave3d.transforms.flatten?s=h:h.type===Behave3d.transforms.opacity&&(h.opacity=h.opacity.toFixed(Behave3d.consts.PRECISION_OPACITY),""===r&&(r=1),r*=h.opacity)}var d=e.join(" ");d!=this.last_transform_str&&(this.element.style[Behave3d.vars.cssPropTransform]=this.last_transform_str=d,Behave3d.consts.DEBUG&&(Behave3d.vars.debugInfo.count_transformed_elements++,Behave3d.vars.debugInfo.count_translations+=a,Behave3d.vars.debugInfo.count_rotations+=n,Behave3d.vars.debugInfo.count_scalings+=o));var v=t?100*t.ox+"% "+100*t.oy+"% "+t.oz+"px":"";v!=this.last_origin_str&&(this.element.style[Behave3d.vars.cssPropTransformOrigin]=this.last_origin_str=v);var l=s&&s.flatten?"flat":"preserve-3d";l!=this.last_style_str&&(this.element.style[Behave3d.vars.cssPropTransformStyle]=this.last_style_str=l),r!==this.last_opacity_str&&(this.element.style.opacity=this.last_opacity_str=r,Behave3d.consts.DEBUG&&Behave3d.vars.debugInfo.count_opacities++)}},Behave3d.Element.prototype.getAccForSuddenStop=function(e){void 0===e&&(e=1/Behave3d.consts.FRAME_RATE);var t=this.velocity,s=this.acc,r=e;return{x:-s.x-t.x/r,y:-s.y-t.y/r,z:-s.z-t.z/r}},Behave3d.Element.prototype.calcPhysics=function(e,t){if(this.physics_enabled){void 0===t&&(t=1/Behave3d.consts.FRAME_RATE);var s=this.pos,r=this.velocity,a=this.acc,n=t,o=n*n/2;if(!this.actions_controller.paused){var i=r.x*n+a.x*o,h=r.y*n+a.y*o,d=r.z*n+a.z*o;s.x+=i,s.y+=h,s.z+=d,r.x+=a.x*n,r.y+=a.y*n,r.z+=a.z*n}e&&this.transforms.unshift({type:Behave3d.transforms.translate,dx:s.x,dy:s.y,dz:s.z})}},Behave3d.Element.prototype.makeChildOfScene=function(){var e=Behave3d.getElementPos(this.element);Behave3d.vars.sceneContainer.appendChild(this.element),this.element.style.position="absolute",this.element.style.left=e.x+"px",this.element.style.top=e.y+"px"},Behave3d.Element.prototype.fireEvent=function(e,t,s){void 0===s&&(s="local");var r="global"==s,a="parents"==s||"p_and_c"==s,n="children"==s||"p_and_c"==s,o="local"==s,i=0;if(o&&!r)for(var h=0;h<this.controllers.length;h++)i+=this.controllers[h].fireEvent(e,t,"controller");if(r)for(var d=0;d<Behave3d.vars.elementsPool.length;d++)i+=Behave3d.vars.elementsPool[d][Behave3d.consts.BEHAVE3D_PROPERTY].fireEvent(e,t,"local");if(a)for(var v;(v=this.element.parentNode)&&v!=document;)v[Behave3d.consts.BEHAVE3D_PROPERTY]&&(i+=v[Behave3d.consts.BEHAVE3D_PROPERTY].fireEvent(e,t,"local"));if(n)for(var l=this.childNodes?this.childNodes:this.element.childNodes,c=0;c<l.length;c++){var m=l[c];m[Behave3d.consts.BEHAVE3D_PROPERTY]?(i+=m[Behave3d.consts.BEHAVE3D_PROPERTY].fireEvent(e,t,"local"),i+=m[Behave3d.consts.BEHAVE3D_PROPERTY].fireEvent(e,t,"children")):i+=Behave3d.Element.prototype.fireEvent.call(m,e,t,"children")}return i},Behave3d.Element.prototype.debugName=function(){return this.element.nodeName+("#"+this.element.id)},Behave3d.Controller=function(e,t){if(void 0===e&&(e={}),this.unique_id=Behave3d.vars.uniqueIDCounter++,this.id="",this.disabled=!1,this.paused=!1,this.params_changed=!1,this.targets=[],this.event_handlers={},this.owner=null,this.default_params)for(var s in this.default_params)this[s]=this.default_params[s];this.set(e,"params"),t&&(this.owner.physics_enabled=!0),Behave3d.debugOut("Controller - create: "+this.debugName()),this.construct&&this.construct(e,"params")},Behave3d.Controller.common_messages=["pause","unpause","enable","disable","params","remove"],Behave3d.Controller.prototype={},Behave3d.Controller.prototype.setParam=function(e,t,s){void 0===s&&(s=""),"string"==typeof t&&"toggle"==t.toLowerCase()&&this.hasOwnProperty(e)&&"boolean"==typeof this[e]&&(t=this[e]?!1:!0);var r=""==s||"message"==s,a=r||"events"==s,n=r||"messages"==s,o=r||"params"==s,i=r,h="message"==s;if("paused"==e||"disabled"==e){var d=this[e];return o&&(this[e]=t),i&&t!=d&&this.fireEvent(1==t?e:"paused"==e?"unpaused":"enabled"),!0}if(" on"==e.substr(-3))return a&&this.on(t,e.substr(0,e.length-3).trim()),this;if(Behave3d.Controller.common_messages.indexOf(e)>=0||this.messages&&this.messages.indexOf(e)>=0)return n&&this.message(e,t),this;if(this instanceof Behave3d.controllerActions&&!this.hasOwnProperty(e))return n&&this.message(e,t),this;if(o)if(["construct","destruct","message","update"].indexOf(e)>=0){var v="string"==typeof t?Behave3d.getFunctionByName(t):t;"function"==typeof v?this[e]=v:Behave3d.debugExit("Controller "+this.debugName()+" received invalid param ("+t+") that cannot override method "+e+"(), function or function name is expected.")}else this.hasOwnProperty(e)?(this instanceof Behave3d.controllerActions&&"id"==e&&"a"!=t&&Behave3d.debugExit("Controller "+this.debugName()+" is not allowed to have its id changed to "+t),this[e]=t,this.params_changed=!0):h||Behave3d.debugExit("Controller "+this.debugName()+" received unknown param '"+e+"'");return this},Behave3d.Controller.prototype.set=function(e,t){if(Array.isArray(e))for(var s=0;s<e.length;s++)this.setParam(e[s][0],e[s][1],t);else{"string"==typeof e&&(e=Behave3d.params.parseParamsString(e,!0));for(var r in e)this.setParam(r,e[r],t)}return this},Behave3d.Controller.prototype.paramsHaveChanged=function(e){return this.params_changed&&(e||!(this.params_changed=!1))},Behave3d.Controller.prototype.setMessageParams=function(e,t){return void 0===t?t={}:"object"==typeof t&&this.set(t,"message"),t},Behave3d.Controller.prototype.message=function(e,t){return this.handleCommonMessage(e,t),this},Behave3d.Controller.prototype.handleCommonMessage=function(e,t){return Behave3d.debugOut("Message received: '"+e+"' by "+this.debugName()),this.disabled&&-1==["enable","remove","params"].indexOf(e)?!0:this.messages&&this.messages.indexOf(e)>=0?!1:(this.setMessageParams(e,t),"pause"==e||"unpause"==e?this.set({paused:"pause"==e}):"enable"==e||"disable"==e?this.set({disabled:"disable"==e}):"params"==e?this.set(t):"remove"==e?this.owner.removeController(this):Behave3d.debugExit(this.debugName()+" received unknown message '"+e+"'"),!0)},Behave3d.Controller.prototype.on=function(e,t,s){var r={element:this.owner,controller:this,event:""},a=[];if(Array.isArray(e)){for(var n=0;n<e.length;n++)a.push(this.on(e[n],t),!0);return s?a:this}var o=("string"==typeof e?e:""+e).split(" "),i=0,h=this.debugName()+".on('"+e+"', "+("string"==typeof t?"'"+t+"'":"function()")+")";if(o.length>2&&"after"==o[1]&&(i=Number(o[0]),o.splice(0,2)),1==o.length)Behave3d.params.isNumber(o[0])?(i=Number(o[0]),r.event=!0):r.event=o[0];else if(2==o.length)r.controller=this.owner.getController(o[0]),r.controller||Behave3d.debugExit(h+": cannot find controller '"+o[0]+"'"),r.event=o[1];else if(3==o.length){var d=[];if("@targets"==o[0])for(var n=0;n<this.targets.length;n++)d.push(this.getTarget(n));else d.push(this.owner.getDOMElement(o[0],!0));for(var n=0;n<d.length;n++)a.push({element:d[n],controller:d[n].getController(o[1])||Behave3d.debugExit(h+": cannot find controller '"+o[1]+"'"),event:o[2]})}0==a.length&&a.push(r);for(var v="string"==typeof t?function(e,s){this.message(t,s)}.bind(this):t.bind(this),l=i?function(e,t){window.setTimeout(function(){v(e,t)},i)}:v,n=0;n<a.length;n++)a[n].event===!0?(l(),Behave3d.debugOut("Delay trigger created: "+h)):a[n].controller.addEventHandler(a[n].event,l);return s?a.length>1?a:a[0]:this},Behave3d.Controller.prototype.off=function(e,t){if(Array.isArray(e))for(var s=0;s<e.length;s++)this.off(e[s],t);return t?this.removeEventHandler(e,t):delete this.event_handlers[e],this},Behave3d.Controller.prototype.addEventHandler=function(e,t){this.event_handlers[e]||(this.event_handlers[e]=[]),this.event_handlers[e].push(t),Behave3d.debugOut("Handler created: '"+e+"' on "+this.debugName())},Behave3d.Controller.prototype.removeEventHandler=function(e,t){if(this.event_handlers[e]){var s=this.event_handlers[e];if(s.indexOf(t)>=0){for(var r=s.length-1;r>=0;r--)s[r]===t&&s.splice(r,1);Behave3d.debugOut("Handler removed: '"+e+"' on "+this.debugName())}}},Behave3d.Controller.prototype.relayEvents=function(e,t){for(var s in t)(function(e,s,r){this.on(e,function(s){r.fireEvent(t[e],s)})}).bind(this)(s,t[s],e)},Behave3d.Controller.prototype.fireEvent=function(e,t,s){if(void 0===s&&(s="controller"),
"controller"==s){for(var r=(this.event_handlers[e]?this.event_handlers[e]:[]).concat(this.event_handlers.all?this.event_handlers.all:[]),a=0;a<r.length;a++)r[a].call(this,e,t);return r.length}return this.owner.fireEvent(e,t,s)},Behave3d.Controller.prototype.getAnotherController=function(e){var t=e.split(" ");return 1==t.length?this.owner.getController(e)||Behave3d.debugExit(this.debugName+" cannot find another controller with id = '"+e+"'"):Behave3d(e,!1)},Behave3d.Controller.prototype.getComputedLengths=function(e,t,s,r){for(var a={},n=0;n<e.length;n++)a[e[n]]=Behave3d.params.getLength(this[e[n]],"X",this.owner.element,r);if(t)for(var n=0;n<t.length;n++)a[t[n]]=Behave3d.params.getLength(this[t[n]],"Y",this.owner.element,r);if(s)for(var n=0;n<s.length;n++)a[s[n]]=Behave3d.params.getLength(this[s[n]],"Z",this.owner.element,r);return a},Behave3d.Controller.prototype.getTarget=function(e){return this.targets[e][Behave3d.consts.BEHAVE3D_PROPERTY]},Behave3d.Controller.prototype.makeTargetsDom3d=function(e){void 0===e&&(e=!0);for(var t=0;t<this.targets.length;t++){var s=this.targets[t];s[Behave3d.consts.BEHAVE3D_PROPERTY]||new Behave3d.Element(s,e)}return this},Behave3d.Controller.prototype.registerActions=function(e,t,s){function r(e,t,s){var r=e[t];e[t]=e[s],e[s]=r}if(!e)return this;var a=0,n="",o=!1;if("string"==typeof e&&e.length>0){var i=e.split(" ");"reverse"==i[0]&&(o=!0,i=i.splice(1)),a=Number(i[0]),n=i[1]||""}else"number"==typeof e&&(a=e);var h=n?n+" ":"",d=(a?a+" after ":"")+h;if("string"==typeof t){var v=t.split(" "),l=[];v.indexOf("showhide")>=0&&(l=l.concat(["show","hide","show_immediately","hide_immediately"])),t={};for(var c=0;c<l.length;c++)t[l[c]]=l[c]}if(o){for(var m in t)"show"==m?r(t,"show","hide"):"show_immediately"==m&&r(t,"show_immediately","hide_immediately");for(var u in s)"show_start"==u?r(s,"show_start","hide_start"):"show_end"==u&&r(s,"show_end","hide_end")}for(var m in t){var f="_immediately"==m.substr(-12);this.on((f?h:d)+"a "+m,t[m])}if("string"==typeof s){var p=s.split(" "),B=[];p.indexOf("showhide")>=0&&(B=B.concat(["show_start","show_end","hide_start","hide_end"])),s={};for(var c=0;c<B.length;c++)s[B[c]]=B[c]}var g=(n?this.owner.getDOMElement(n,!0):this.owner).actions_controller;for(var u in s)(function(e,t,s){Array.isArray(t)||(t=[t]);for(var r=0;r<t.length;r++)this.on(t[r],function(t){s.fireEvent(e,t)})}).bind(this)(u,s[u],g);return this.actions_registered=!0,this},Behave3d.Controller.prototype.setSubcontrollersEvents=function(e){this.on("paused",function(){for(var t=0;t<e.length;t++)e[t].set({paused:this.paused})})},Behave3d.Controller.prototype.setChildTargets=function(e,t){void 0===e&&(e=-1),void 0===t&&(t=!0);for(var s=[],r=[],a={removed:[],inserted:[]},n=[],o=0;o<this.owner.element.childNodes.length&&!(-1!=e&&n.length>=e);o++){var i=this.owner.element.childNodes[o];i.nodeType==Node.ELEMENT_NODE&&n.push(i)}for(var o=0;o<this.targets.length;o++)this.targets[o]!=this.owner.element&&-1==n.indexOf(this.targets[o])&&(s.push([o,this.targets[o]]),Behave3d(this.targets[o]).removeFromPool());this.targets=n;for(var o=0;o<this.targets.length;o++)this.targets[o][Behave3d.consts.BEHAVE3D_PROPERTY]||(new Behave3d.Element(this.targets[o],t),r.push([o,this.targets[o]]));for(var o=0;o<s.length;o++){for(var h=[s[o][1]],d=o+1;s[d]&&s[d][0]==s[o][0]+d-o;)h.push(s[d][1]),d++;a.removed.push({first_pos:o,last_pos:d-1,elements:h}),o=d-1}for(var o=0;o<r.length;o++){for(var h=[r[o][1]],d=o+1;r[d]&&r[d][0]==r[o][0]+d-o;)h.push(r[d][1]),d++;a.inserted.push({first_pos:o,last_pos:d-1,elements:h}),o=d-1}return a},Behave3d.Controller.prototype.addTransform=function(e,t){if(void 0===t)for(var s=0;s<this.targets.length;s++)this.getTarget(s).addTransform(e);else this.getTarget(t).addTransform(e);return this},Behave3d.Controller.prototype.applySpringForce=function(e,t,s,r){if(0!=t)if(void 0!==r&&-1!=r){var a=this.getTarget(r),n=a.pos,o=(a.velocity,a.acc),i=e.x-n.x,h=e.y-n.y,d=e.z-n.z;if(0!=s){var v=Math.sqrt(i*i+h*h+d*d),l=v/s,c=a.getAccForSuddenStop(),m=(Math.sqrt(c.x*c.x+c.y*c.y+c.z*c.z),Math.min(1,l*l*l*l));o.x+=c.x*m,o.y+=c.y*m,o.z+=c.z*m}o.x+=i*t,o.y+=h*t,o.z+=d*t}else for(var u=0;u<this.targets.length;u++)this.applySpringForce(e,t,s,u)},Behave3d.Controller.prototype.applyGravityForce=function(e,t,s,r){if(0!=t)if(void 0!==r&&-1!=r){t*=Behave3d.consts.GRAVITY_CONSTANT;var a=this.getTarget(r),n=a.pos,o=(a.velocity,a.acc),i=(e.x-n.x)*s,h=(e.y-n.y)*s,d=(e.z-n.z)*s,v=Math.sqrt(i*i+h*h+d*d),l=t/v;v>=5*s&&(o.x+=l*i/v,o.y+=l*h/v,o.z+=l*d/v)}else for(var c=0;c<this.targets.length;c++)this.applyGravityForce(e,t,s,c)},Behave3d.Controller.prototype.applySpeedDamping=function(e,t){if(1!=e)if(void 0!==t&&-1!=t){var s=this.getTarget(t),r=s.velocity;r.x*=this.damping_factor,r.y*=this.damping_factor,r.z*=this.damping_factor}else for(var a=0;a<this.targets.length;a++)this.applySpeedDamping(e,a)},Behave3d.Controller.prototype.getPathPos=function(e){for(var t={x:0,y:0,z:0},s=0;s<e.length;s++)e[s].disabled||(t.x+=e[s].path_pos.x,t.y+=e[s].path_pos.y,t.z+=e[s].path_pos.z);return t},Behave3d.Controller.prototype.debugName=function(){return(this.owner?this.owner.debugName():"UnassignedController")+":"+this.id+"(#"+this.unique_id+" "+this.title+")"},Behave3d.StepEngine=function(e,t,s,r){this.is_circular=t,this.events_controller=s||null,this.options=r||{},this.var_names=Object.keys(e),this.vars={},this.lagged_vars={},this.vars_speeds={};for(var a in e)this.vars[a]=e[a],this.lagged_vars[a]=e[a],this.vars_speeds[a]=0;0==this.var_names.length&&Behave3d.debugExit("Behave3d.StepEngine() contructor received empty 'vars' object");for(var n in Behave3d.StepEngine.default_options)void 0===this.options[n]&&(this.options[n]=Behave3d.StepEngine.default_options[n]);this.is_circular&&(void 0===this.options.marked_angle&&(this.options.marked_angle=-1),void 0===this.options.cycle_len&&(this.options.cycle_len=Behave3d.consts.ROTATE_ONE_TURN)),this.stop()},Behave3d.StepEngine.events=["start","half","end","start_back","half_back","end_back","pos0","pos1","cycle","mark","cycle_back","mark_back"],Behave3d.StepEngine.default_options={ease_type:"linear",ease_amount:1,ease_mirror:!1,half_step:1,spring_acc:0,spring_vdamp:1,always_fire_start_end:!0},Behave3d.StepEngine.prototype={},Behave3d.StepEngine.prototype.getVar=function(e,t){return t?this.vars[e]:this.lagged_vars[e]},Behave3d.StepEngine.prototype.setVar=function(e,t,s){this.vars[e]=t,s||(this.lagged_vars[e]=t,this.vars_speeds[e]=0)},Behave3d.StepEngine.prototype.stop=function(){this.direction=0,this.pos=0},Behave3d.StepEngine.prototype.setMovement=function(e,t,s){if(void 0===s&&(s=!0),this.direction=0,this.duration=t,s||!this.movement_start){this.movement_start={},this.movement_end={},this.pos=0,this.starting_angle=this.vars[this.var_names[0]];for(var r in this.vars)this.movement_start[r]=this.vars[r],this.movement_end[r]=this.vars[r]+e[r]}return!0},Behave3d.StepEngine.prototype.isMoving=function(){return 0!=this.direction},Behave3d.StepEngine.prototype.start=function(e,t,s,r,a){void 0===e&&(e=1),void 0===t&&(t=!1),void 0===s&&(s=!0),r&&this.setMovement(r,a,s);var n=1==e?this.movement_start:this.movement_end,o=1==e?this.movement_end:this.movement_start;if(t&&this.movement_start)for(var i in this.vars)this.vars[i]=n[i];this.current_movement={},this.current_start={};for(var i in this.vars)this.current_movement[i]=o[i]-this.vars[i],this.current_start[i]=this.vars[i];return this.pos<0?this.pos=0:this.pos>1&&(this.pos=1),this.movement_dpos=t||s?1:1==e?1-this.pos:this.pos,this.movement_dpos>0||this.options.always_fire_start_end?(this.total_frames=Math.round(this.duration*this.movement_dpos/Behave3d.vars.frameDuration),this.frames_left=this.total_frames,this.direction=e,this.events_suffix=-1==this.direction?"_back":"",this.current_ease=this.ease_mirror&&-1==this.direction?Behave3d.ease.mirrorMap[this.options.ease_type]:this.options.ease_type,0==this.total_frames&&this.update(!1)):this.direction=0,!0},Behave3d.StepEngine.prototype.update=function(e){var t=!1;if(!e&&0!=this.direction){var s={};for(var r in this.vars)s[r]=this.vars[r];for(var r in this.vars)this.vars[r]=this.current_start[r]+Behave3d.ease(this.current_movement[r],this.current_ease,this.options.ease_amount,this.total_frames,this.total_frames-this.frames_left,"total");if(this.events_controller&&this.frames_left==this.total_frames&&this.events_controller.fireEvent("start"+this.events_suffix),this.events_controller&&this.frames_left==Math.floor(this.total_frames/2)&&this.events_controller.fireEvent("half"+this.events_suffix),this.is_circular){if(this.options.cycle_len>0&&this.frames_left<this.total_frames){var r=this.var_names[0];Behave3d.isAnglePassed(this.starting_angle,this.vars[r],s[r],this.options.cycle_len)&&this.events_controller.fireEvent("cycle"+this.events_suffix)}if(-1!=this.options.marked_angle){var r=this.var_names[0];Behave3d.isAnglePassed(this.options.marked_angle,this.vars[r],s[r],this.options.cycle_len)&&this.events_controller.fireEvent("mark"+this.events_suffix)}}if(this.frames_left>0&&(this.frames_left--,this.pos+=this.direction*this.movement_dpos/this.total_frames),0==this.frames_left){for(var r in this.vars)this.vars[r]=1==this.direction?this.movement_end[r]:this.movement_start[r];this.pos=1==this.direction?1:0,this.direction=0,this.events_controller&&(this.events_controller.fireEvent("end"+this.events_suffix),this.events_controller.fireEvent("pos"+this.pos)),t=!0}}if(1!=this.options.half_step)for(var r in this.vars)this.lagged_vars[r]+=(this.vars[r]-this.lagged_vars[r])*this.options.half_step;if(0!=this.options.spring_acc)for(var r in this.vars)this.vars_speeds[r]+=(this.vars[r]-this.lagged_vars[r])*this.options.spring_acc,this.vars_speeds[r]*=this.options.spring_vdamp,this.lagged_vars[r]+=this.vars_speeds[r];if(1==this.options.half_step&&0==this.options.spring_acc)for(var r in this.vars)this.lagged_vars[r]=this.vars[r];return t},Behave3d.startEngine();