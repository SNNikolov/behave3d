"use strict";Behave3d.controllerMenu=function(e){Behave3d.Controller.call(this,e)},Behave3d.controllerMenu.prototype=Object.create(Behave3d.Controller.prototype),Behave3d.controllerMenu.prototype.requires={controllers:[]},Behave3d.controllerMenu.prototype.messages=["show","show_immediately","hide","hide_immediately","button_clicked"],Behave3d.controllerMenu.prototype.events=["focus","blur","mousein","mouseout","button_clicked","item_clicked","inner_item_clicked"],Behave3d.controllerMenu.prototype.default_params={parent_menu:null,show_button:null,collapse_subs:!0,hide_on_blur:!0,align:"rltt",submenus_align:"same",highlight_class:"",for_each_item:"",for_each_menu:""},Behave3d.controllerMenu.prototype.highlight_class_attribute="highlight_class",Behave3d.controllerMenu.prototype.construct=function(e,t){"params"==t?(this.menu_shown=!0,this.pointer_is_in_menu=!1,this.show_operation_id=1,this.mouse_operation_id=1,this.active_event_listeners=[],this.top_menu=this.parent_menu?this.parent_menu.top_menu:this,this.submenus=[],this.menu_items=[],this.createMenuStructure(this,null)):"events"==t&&this.setEventHandlers()},Behave3d.controllerMenu.prototype.destruct=function(){for(var e=0;e<this.active_event_listeners.length;e++){var t=this.active_event_listeners[e];t.condition&&t.element.removeEventListener(t.type,t.handle,t.useCapture)}},Behave3d.controllerMenu.prototype.message=function(e,t){if(this.handleCommonMessage(e,t))return this;if(t=this.setMessageParams(e,t),"update"==e);else if("reset"==e);else if("show"!=e&&"show_immediately"!=e||this.menu_shown)if("hide"!=e&&"hide_immediately"!=e||!this.menu_shown)"button_clicked"==e&&(this.fireEvent("button_clicked"),this.message(this.menu_shown?"hide":"show"));else{if(void 0!==t.show_op_id&&this.show_operation_id!=t.show_op_id)return;if(void 0!==t.mouse_op_id&&this.mouse_operation_id!=t.mouse_op_id)return;var i=this.owner.element.style.display||window.getComputedStyle(this.owner.element,null).getPropertyValue("display");if(this.display_style="none"==i?"block":i,this.menu_shown=!1,this.owner.element.style.pointerEvents="none",this.collapse_subs)for(var n=0;n<this.submenus.length;n++)this.submenus[n].message(e);0==this.owner.actions_controller.fireEvent(e)&&(this.owner.element.style.display="none"),this.applyShowButtonStyle(),this.show_operation_id++}else{if(void 0!==t.show_op_id&&this.show_operation_id!=t.show_op_id)return;this.menu_shown=!0,0==this.owner.actions_controller.fireEvent(e)&&this.display_style&&(this.owner.element.style.display=this.display_style),this.owner.element.focus(),this.owner.element.style.pointerEvents="auto",this.alignMenu(this.show_button,this.align),this.applyShowButtonStyle(),this.show_operation_id++}return this},Behave3d.controllerMenu.prototype.update=function(){},Behave3d.controllerMenu.prototype.createMenuStructure=function(e,t){this.for_each_item=Behave3d.getFunctionByName(this.for_each_item),this.for_each_menu=Behave3d.getFunctionByName(this.for_each_menu),this.for_each_menu&&this.for_each_menu.bind(this)(),this.submenus=[],this.menu_items=[];for(var i=0,n=0;n<e.owner.element.childNodes.length;n++){var s=e.owner.element.childNodes[n];if(s.nodeType==Node.ELEMENT_NODE){for(var o=null,h=null,r=0;r<s.childNodes.length;r++){var l=s.childNodes[r];if(l.nodeType==Node.ELEMENT_NODE){if(o){h=Behave3d(l).addController(Behave3d.controllerMenu,{id:this.id,parent_menu:e,show_button:o,align:"same"==this.submenus_align?this.align:this.submenus_align,for_each_item:this.for_each_item,for_each_menu:this.for_each_menu}),this.submenus.push(h);break}o=l,this.menu_items.push(o)}}this.for_each_item&&this.for_each_item.call(s,this,i,o,h),i++}}},Behave3d.controllerMenu.prototype.setEventHandlers=function(){this.owner.element.tabIndex=-1;for(var e=0,t=0;t<this.menu_items.length;t++){for(var i=this.menu_items[t],n=!1,s=e;s<this.submenus.length;s++)if(this.submenus[s].show_button===i){n=!0,e=s+1;break}n||function(e,t){e.addEventListener("click",function(i){this.fireEvent("item_clicked",{pos:t,item:e});for(var n=this;n;)n.fireEvent("inner_item_clicked",{menu:this,pos:t,item:e}),n=n.parent_menu}.bind(this),!0)}.call(this,i,t)}if(this.show_button&&(this.show_button=this.owner.getDOMElement(this.show_button),this.show_button.addEventListener("click",function(e){this.message("button_clicked"),e.stopPropagation(),e.preventDefault()}.bind(this),!0)),!this.parent_menu){var o=this.focusEventListener.bind(this);this.active_event_listeners=[{element:document,type:"mouseover",handle:o,useCapture:!0,condition:!0},{element:document,type:"focus",handle:o,useCapture:!0,condition:!0},{element:document,type:"click",handle:o,useCapture:!0,condition:!0}];for(var t=0;t<this.active_event_listeners.length;t++){var h=this.active_event_listeners[t];h.condition&&h.element.addEventListener(h.type,h.handle,h.useCapture)}}},Behave3d.controllerMenu.prototype.focusEventListener=function(e,t){var i=null,n=!0;if("mouseover"==e.type){var s=this.isElementPartOfMenu(e.target);s&&!this.pointer_is_in_menu?(this.mouse_operation_id++,this.pointer_is_in_menu=!0,this.fireEvent("mousein",{mouse_op_id:this.mouse_operation_id,show_op_id:this.show_operation_id})):!s&&this.pointer_is_in_menu&&(this.mouse_operation_id++,this.pointer_is_in_menu=!1,this.fireEvent("mouseout",{mouse_op_id:this.mouse_operation_id,show_op_id:this.show_operation_id}))}else"click"==e.type?i=e.target:"focus"==e.type&&(i=document.activeElement);if(i){if(i===this.show_button)return;var o=this.isElementPartOfMenu(i);o&&(o=!(document.activeElement&&"IFRAME"==document.activeElement.tagName)),o&&!this.menu_shown?(this.fireEvent("focus",{show_op_id:this.show_operation_id}),this.message("show")):!o&&this.menu_shown&&(this.fireEvent("blur",{show_op_id:this.show_operation_id}),this.hide_on_blur&&this.message("hide"))}if(n)for(var h=0;h<this.submenus.length;h++)this.submenus[h].focusEventListener(e,!0)},Behave3d.controllerMenu.prototype.isElementPartOfMenu=function(e){return e==this.owner.element||this.owner.element.contains(e)},Behave3d.controllerMenu.prototype.applyShowButtonStyle=function(){if(this.show_button){var e=this.show_button.getAttribute(this.highlight_class_attribute);!e&&this.parent_menu&&(e=this.parent_menu.highlight_class),!e&&this.parent_menu&&this.parent_menu.owner.element.hasAttribute(this.highlight_class_attribute)&&(e=this.parent_menu.owner.element.getAttribute(this.highlight_class_attribute)),e&&(this.menu_shown?this.show_button.classList.add(e):this.show_button.classList.remove(e))}},Behave3d.controllerMenu.prototype.alignMenu=function(e,t){if(""==t||"none"==t||!e)return!1;4!=t.length&&Behave3d.debugExit(this.debugName()+" is assigned invalid param 'align' = "+t);var i=t.substr(0,2),n=t.substr(2,2),s={l:0,c:.5,r:1},o={t:0,m:.5,b:1},h=e.getBoundingClientRect(),r=this.owner.element.parentNode.getBoundingClientRect(),l=h.left;l+=(h.right-h.left)*s[i[0]],l-=this.owner.element.clientWidth*s[i[1]],l-=r.left;var u=h.top;return u+=(h.bottom-h.top)*o[n[0]],u-=this.owner.element.clientHeight*o[n[1]],u-=r.top,this.owner.element.style.left=Math.round(l)+"px",this.owner.element.style.top=Math.round(u)+"px",!0},Behave3d.registerController("menu",Behave3d.controllerMenu);