"use strict";Behave3d.controllerMenu=function(a){Behave3d.Controller.call(this,a)};Behave3d.controllerMenu.prototype=Object.create(Behave3d.Controller.prototype);Behave3d.controllerMenu.prototype.requires={controllers:[]};Behave3d.controllerMenu.prototype.messages=["show","show_immediately","hide","hide_immediately","button_clicked"];Behave3d.controllerMenu.prototype.events=["focus","blur","mousein","mouseout","button_clicked","item_clicked","inner_item_clicked"];Behave3d.controllerMenu.prototype.default_params={parent_menu:null,show_button:null,collapse_subs:!0,hide_on_blur:!0,align:"rltt",submenus_align:"same",highlight_class:"",for_each_item:"",for_each_menu:""};Behave3d.controllerMenu.prototype.highlight_class_attribute="highlight_class";Behave3d.controllerMenu.prototype.construct=function(a,b){if(b=="params"){this.menu_shown=!0;this.pointer_is_in_menu=!1;this.show_operation_id=1;this.mouse_operation_id=1;this.active_event_listeners=[];this.top_menu=this.parent_menu?this.parent_menu.top_menu:this;this.submenus=[];this.menu_items=[];this.createMenuStructure(this,null)}else if(b=="events"){this.setEventHandlers()}else if(b=="messages"){}};Behave3d.controllerMenu.prototype.destruct=function(){for(var i=0;i<this.active_event_listeners.length;i++){var a=this.active_event_listeners[i];if(a.condition)a.element.removeEventListener(a.type,a.handle,a.useCapture)}};Behave3d.controllerMenu.prototype.message=function(a,b){if(this.handleCommonMessage(a,b))return this;b=this.setMessageParams(a,b);if(a=="update"){}else if(a=="reset"){}else if((a=="show"||a=="show_immediately")&&!this.menu_shown){if(b.show_op_id!==void 0)if(this.show_operation_id!=b.show_op_id)return;this.menu_shown=!0;if(this.owner.actions_controller.fireEvent(a)==0)if(this.display_style)this.owner.element.style.display=this.display_style;this.owner.element.focus();this.owner.element.style.pointerEvents="auto";this.alignMenu(this.show_button,this.align);this.applyShowButtonStyle();this.show_operation_id++}else if((a=="hide"||a=="hide_immediately")&&this.menu_shown){if(b.show_op_id!==void 0)if(this.show_operation_id!=b.show_op_id)return;if(b.mouse_op_id!==void 0)if(this.mouse_operation_id!=b.mouse_op_id)return;var c=this.owner.element.style.display||window.getComputedStyle(this.owner.element,null).getPropertyValue("display");this.display_style=c=="none"?"block":c;this.menu_shown=!1;this.owner.element.style.pointerEvents="none";if(this.collapse_subs)for(var i=0;i<this.submenus.length;i++){this.submenus[i].message(a)}if(this.owner.actions_controller.fireEvent(a)==0)this.owner.element.style.display="none";this.applyShowButtonStyle();this.show_operation_id++}else if(a=="button_clicked"){this.fireEvent("button_clicked");this.message(this.menu_shown?"hide":"show")}return this};Behave3d.controllerMenu.prototype.update=()=>{};Behave3d.controllerMenu.prototype.createMenuStructure=function(a,b){this.for_each_item=Behave3d.getFunctionByName(this.for_each_item);this.for_each_menu=Behave3d.getFunctionByName(this.for_each_menu);if(this.for_each_menu)this.for_each_menu.bind(this)();this.submenus=[];this.menu_items=[];var c=0;for(var d=0;d<a.owner.element.childNodes.length;d++){var e=a.owner.element.childNodes[d];if(e.nodeType!=Node.ELEMENT_NODE)continue;var f=null,g=null;for(var i=0;i<e.childNodes.length;i++){var h=e.childNodes[i];if(h.nodeType!=Node.ELEMENT_NODE)continue;if(!f){f=h;this.menu_items.push(f)}else{g=Behave3d(h).addController(Behave3d.controllerMenu,{id:this.id,parent_menu:a,show_button:f,align:this.submenus_align=="same"?this.align:this.submenus_align,for_each_item:this.for_each_item,for_each_menu:this.for_each_menu});this.submenus.push(g);break}}if(this.for_each_item)this.for_each_item.call(e,this,c,f,g);c++}};Behave3d.controllerMenu.prototype.setEventHandlers=function(){this.owner.element.tabIndex=-1;var a=0;for(var i=0;i<this.menu_items.length;i++){var b=this.menu_items[i],c=!1;for(var d=a;d<this.submenus.length;d++){if(this.submenus[d].show_button===b){c=!0;a=d+1;break}}if(!c)(function(g,i){g.addEventListener("click",function(h){this.fireEvent("item_clicked",{pos:i,item:g});var j=this;while(j){j.fireEvent("inner_item_clicked",{menu:this,pos:i,item:g});j=j.parent_menu}}.bind(this),!0)}).call(this,b,i)}if(this.show_button){this.show_button=this.owner.getDOMElement(this.show_button);this.show_button.addEventListener("click",function(g){this.message("button_clicked");g.stopPropagation();g.preventDefault()}.bind(this),!0)}if(!this.parent_menu){var e=this.focusEventListener.bind(this);this.active_event_listeners=[{element:document,type:"mouseover",handle:e,useCapture:!0,condition:!0},{element:document,type:"focus",handle:e,useCapture:!0,condition:!0},{element:document,type:"click",handle:e,useCapture:!0,condition:!0}];for(var i=0;i<this.active_event_listeners.length;i++){var f=this.active_event_listeners[i];if(f.condition)f.element.addEventListener(f.type,f.handle,f.useCapture)}}};Behave3d.controllerMenu.prototype.focusEventListener=function(a,b){var c=null,d=!0;if(a.type=="mouseover"){var e=this.isElementPartOfMenu(a.target);if(e&&!this.pointer_is_in_menu){this.mouse_operation_id++;this.pointer_is_in_menu=!0;this.fireEvent("mousein",{mouse_op_id:this.mouse_operation_id,show_op_id:this.show_operation_id})}else if(!e&&this.pointer_is_in_menu){this.mouse_operation_id++;this.pointer_is_in_menu=!1;this.fireEvent("mouseout",{mouse_op_id:this.mouse_operation_id,show_op_id:this.show_operation_id})}}else if(a.type=="click")c=a.target;else if(a.type=="focus")c=document.activeElement;if(c){if(c===this.show_button)return;var f=this.isElementPartOfMenu(c);if(f)f=!(document.activeElement&&document.activeElement.tagName=="IFRAME");if(f&&!this.menu_shown){this.fireEvent("focus",{show_op_id:this.show_operation_id});this.message("show")}else if(!f&&this.menu_shown){this.fireEvent("blur",{show_op_id:this.show_operation_id});if(this.hide_on_blur)this.message("hide")}}for(var i=0;i<this.submenus.length;i++){this.submenus[i].focusEventListener(a,!0)}};Behave3d.controllerMenu.prototype.isElementPartOfMenu=function(a){return a==this.owner.element||this.owner.element.contains(a)};Behave3d.controllerMenu.prototype.applyShowButtonStyle=function(){if(!this.show_button)return;var a=this.show_button.getAttribute(this.highlight_class_attribute);if(!a&&this.parent_menu)a=this.parent_menu.highlight_class;if(!a&&this.parent_menu&&this.parent_menu.owner.element.hasAttribute(this.highlight_class_attribute))a=this.parent_menu.owner.element.getAttribute(this.highlight_class_attribute);if(!a)return;if(this.menu_shown)this.show_button.classList.add(a);else this.show_button.classList.remove(a)};Behave3d.controllerMenu.prototype.alignMenu=function(a,b){if(b==""||b=="none"||!a)return!1;if(b.length!=4)Behave3d.debugExit(this.debugName()+" is assigned invalid param 'align' = "+b);var c=b.substr(0,2),d=b.substr(2,2),e={l:0,c:0.5,r:1},f={t:0,m:0.5,b:1},g=a.getBoundingClientRect(),h=this.owner.element.parentNode.getBoundingClientRect(),j=g.left;j+=(g.right-g.left)*e[c[0]];j-=this.owner.element.clientWidth*e[c[1]];j-=h.left;var k=g.top;k+=(g.bottom-g.top)*f[d[0]];k-=this.owner.element.clientHeight*f[d[1]];k-=h.top;this.owner.element.style.left=Math.round(j)+"px";this.owner.element.style.top=Math.round(k)+"px";return!0};Behave3d.registerController("menu",Behave3d.controllerMenu);